# 📝 블로그 리뷰 크롤링 가이드

## ✅ 완료된 기능

카카오맵의 블로그 리뷰를 자동으로 크롤링하여 표시하는 기능이 구현되었습니다.

---

## 🎯 주요 특징

### 1. **지연 로딩 (Lazy Loading)** 방식
- ❌ 검색할 때 모든 매장의 블로그 리뷰를 크롤링하지 않음
- ✅ 사용자가 특정 매장을 선택하고 블로그 탭을 클릭할 때만 크롤링 실행
- 💡 **성능 최적화**: 불필요한 크롤링 방지

### 2. **캐싱 시스템**
- 한 번 크롤링한 블로그 리뷰는 30분간 캐시에 저장
- 같은 매장의 블로그 탭을 다시 클릭하면 캐시된 데이터 사용
- 서버 부하 감소 및 응답 속도 향상

---

## 🔄 실행 흐름

```
[검색 단계]
사용자가 "스타벅스" 검색
   ↓
기본 정보 크롤링 (영업시간, 전화번호) - 모든 검색 결과
   ↓
검색 결과 목록 표시

[상세 보기 단계]
사용자가 "스타벅스 유성구청점" 클릭
   ↓
상세 정보 패널 표시 (홈 탭 활성화)
   ↓
사용자가 "블로그" 탭 클릭 👈 이 시점에서만 블로그 크롤링 시작!
   ↓
https://place.map.kakao.com/{매장ID}#blogreview 크롤링
   ↓
블로그 리뷰 목록 표시
```

---

## 📂 관련 파일

| 파일 | 역할 |
|------|------|
| `crawl_blog_reviews.js` | Puppeteer로 블로그 리뷰 크롤링 |
| `server.js` | API 엔드포인트 `/api/crawl/blog-reviews` |
| `public/js/display.js` | `loadBlogReviews()` 함수 |
| `public/js/events.js` | 블로그 탭 클릭 이벤트 처리 |

---

## 🧪 테스트 방법

### 1. 서버 실행
```bash
cd test_server
node server.js
```

### 2. 브라우저에서 테스트
1. `http://localhost:3000` 접속
2. 검색창에 "스타벅스" 입력 후 검색
3. 검색 결과에서 매장 하나 선택
4. 상세 정보 패널에서 **"블로그"** 탭 클릭
5. 블로그 리뷰가 표시되는지 확인

### 3. 콘솔 로그 확인
개발자 도구(F12)를 열고 Console 탭에서 다음 로그 확인:

```
[검색 시]
🕐 기본 정보 크롤링 시작 (영업시간, 전화번호)...
1. 스타벅스 유성구청점 - ID: 27240966
2. 스타벅스 대전청사점 - ID: 1234567
✅ 기본 정보 크롤링 완료

[블로그 탭 클릭 시]
🔄 블로그 탭 선택됨 - 블로그 리뷰 크롤링 요청
📝 블로그 리뷰 크롤링 시작 - Place ID: 27240966
ℹ️ 이 크롤링은 매장 선택 후 블로그 탭 클릭 시에만 실행됩니다.
✅ 블로그 리뷰 크롤링 완료 - 발견된 리뷰 수: 5
```

---

## 🔍 크롤링되는 데이터

각 블로그 리뷰에서 다음 정보를 추출합니다:

- **제목** (title): 블로그 포스트 제목
- **링크** (link): 블로그 원문 URL
- **내용** (content): 블로그 내용 미리보기
- **블로그명** (blogName): 블로그 이름
- **작성일** (date): 포스트 작성 날짜
- **썸네일** (thumbnail): 대표 이미지 URL

---

## 🎨 UI 표시

블로그 리뷰는 다음과 같이 표시됩니다:

```
┌──────────────────────────────────────┐
│ [썸네일]  블로그 포스트 제목         │
│           내용 미리보기...           │
│           블로그명 · 작성일          │
├──────────────────────────────────────┤
│ [썸네일]  다음 블로그 포스트         │
│           ...                        │
└──────────────────────────────────────┘
```

- 썸네일: 80x80px 둥근 모서리
- 제목 클릭 시 블로그 원문으로 이동
- 호버 시 배경색 변경

---

## ⚙️ 설정

### 캐시 지속 시간 변경
`crawl_blog_reviews.js` 파일 상단:
```javascript
const CACHE_DURATION = 1000 * 60 * 30; // 30분 (밀리초 단위)
```

### 타임아웃 설정
```javascript
await page.goto(url, { 
    waitUntil: 'networkidle2', 
    timeout: 20000  // 20초
});
```

### 디버그 스크린샷
```bash
DEBUG_SCREENSHOTS=true node server.js
```
- 크롤링 중 스크린샷을 `debug_blog_{placeId}_{timestamp}.png`로 저장
- 크롤링 문제 디버깅에 유용

---

## 🚨 문제 해결

### 블로그 리뷰가 표시되지 않는 경우

1. **콘솔 확인**
   - 에러 메시지가 있는지 확인
   - `❌ 블로그 리뷰 로딩 실패` 메시지 확인

2. **Puppeteer 설치 확인**
   ```bash
   npm list puppeteer
   ```
   - 설치되지 않았다면: `npm install puppeteer`

3. **매장 ID 확인**
   - 콘솔에서 `place.id` 값이 제대로 출력되는지 확인
   - 카카오맵 API가 ID를 제공하지 않는 경우도 있음

4. **서버 로그 확인**
   ```
   📝 블로그 리뷰 크롤링 요청 - Place ID: xxxxx
   ✅ 블로그 리뷰 크롤링 완료 - 0개 발견
   ```
   - "0개 발견"은 해당 매장에 블로그 리뷰가 없는 경우

---

## 📊 성능 최적화

### 현재 구현된 최적화
✅ 지연 로딩: 필요할 때만 크롤링
✅ 캐싱: 중복 요청 방지
✅ 타임아웃: 무한 대기 방지
✅ 에러 핸들링: 크롤링 실패 시 정상 동작

### 추가 개선 가능 사항
- [ ] 크롤링 결과를 데이터베이스에 저장
- [ ] 백그라운드 작업 큐 사용
- [ ] 여러 페이지 크롤링 (현재는 첫 페이지만)
- [ ] 블로그 리뷰 감정 분석

---

## 📝 요약

| 크롤링 종류 | 실행 시점 | 대상 | 목적 |
|------------|----------|------|------|
| **기본 정보** | 검색 즉시 | 모든 검색 결과 | 검색 목록에 영업시간 표시 |
| **블로그 리뷰** | 블로그 탭 클릭 | 선택한 매장 1개 | 사용자가 원할 때만 로딩 |

**핵심**: 블로그 크롤링은 검색 시가 아니라, 매장 선택 후 블로그 탭 클릭 시에만 실행됩니다! ✅

